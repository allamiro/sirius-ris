<form class="form-element" [formGroup]="form" *ngIf="sharedProp.mainSettings != undefined && sharedProp.mainSettings.appSettings != undefined">
  <div fxLayout="row" fxLayoutAlign="start start">
    <div class="input-wrapper divider-alt"> <!-- start fxLayout wrapper -->
      <h3 class="details-title">Performing details:</h3>
      <div *ngIf="performingData" class="current-wrap">
        <!-- performing_date -->
        <div class="current-info divider-alt">
          <small>Study date:</small><br/>
          <span *ngIf="performingFormattedDate" class="appointment-firts">{{ performingFormattedDate.dateDay + '/' + performingFormattedDate.dateMonth + '/' + performingFormattedDate.dateYear }}</span>
        </div>
        
        <!-- checkin_time -->
        <div class="current-info divider-alt">
          <small>Check-in time:</small><br/>
          <span *ngIf="performingFormattedDate" class="appointment-firts">{{ performingFormattedDate.startHours + ':' + performingFormattedDate.startMinutes }}</span>
        </div>
        
        <!-- imaging -->
        <span *ngIf="performingData.appointment">
          <span *ngIf="performingData.appointment.imaging">
            <span *ngIf="performingData.appointment.imaging.organization && performingData.appointment.imaging.branch && performingData.appointment.imaging.service">
              <div class="current-info">
                <small>Organization ► Branch ► Service:</small><br/>
                <span class="current-firts">{{ performingData.appointment.imaging.organization.short_name + ' ► ' + performingData.appointment.imaging.branch.short_name + ' ► ' + performingData.appointment.imaging.service.name }}</span>
              </div>
            </span>
          </span>
        </span>

        <div class="clear"></div>
      </div>

      <!-- patient -->
      <span *ngIf="performingData.patient">
        <span *ngIf="performingData.patient.person">
          <h3 class="details-title">Patient details:</h3>
          <div class="current-wrap">
            <!-- documents -->
            <div class="current-info">
              <small>Document(s):</small><br/>
              <span *ngFor="let current of performingData.patient.person.documents" >
                <span matTooltip="{{ country_codes[current.doc_country_code].name }}" class="flag-icon flag-icon-{{ country_codes[current.doc_country_code].alpha_2 | lowercase }}"></span>&nbsp;
                <span matTooltip="{{ document_types[current.doc_type] }}">
                  <span>{{ current.document }}</span>
                </span>
                <br/>
              </span>
            </div>
            
            <!-- names -->
            <div class="current-info">
              <small>Full name:</small><br/>
              <span class="current-firts">
                <span>{{ performingData.patient.person.name_01 }}</span>

                <span *ngIf="performingData.patient.person.name_02">
                  <span> {{ performingData.patient.person.name_02 }}</span>
                </span>

                <span> {{ performingData.patient.person.surname_01 }}</span>

                <span *ngIf="performingData.patient.person.surname_02">
                  <span> {{ performingData.patient.person.surname_02 }}</span>
                </span>
              </span>
            </div>
            
            <div class="clear"></div>
          </div>

          <div class="clear"></div>

          <div class="current-wrap">
            <!-- birth_date -->
            <div class="current-info">
              <small>Date of birth:</small><br/>
              <span class="current-firts">{{ performingData.patient.person.birth_date | date:"dd/MM/yyyy":"UTC" }}</span>
            </div>
            
            <!-- genre -->
            <div class="current-info text-center">
              <small>Gender:</small><br/>
              <span [ngSwitch]="performingData.patient.person.gender" matTooltip="{{ gender_types[performingData.patient.person.gender] }}">
                <span *ngSwitchCase="1"><mat-icon class="male">man</mat-icon></span>
                <span *ngSwitchCase="2"><mat-icon class="female">woman</mat-icon></span>
                <span *ngSwitchCase="3"><mat-icon class="other">wc</mat-icon></span>
              </span>
            </div>
            
            <!-- status -->
            <div class="current-info text-center">
              <small>Status:</small><br/>
              <span *ngIf="performingData.patient.status; then thenBlock else elseBlock"></span>
              <ng-template #thenBlock><mat-icon class="color-ok" matTooltip="Active">done</mat-icon></ng-template>
              <ng-template #elseBlock><mat-icon class="color-fail" matTooltip="Inactive">clear</mat-icon></ng-template>
            </div>
            
            <div class="clear"></div>
          </div>

        </span>
      </span>

      <hr class="dashed" />

      <div *ngIf="performingData.appointment" class="text-center">
        <small>Study IUID</small><br/><span class="label-accent">{{ performingData.appointment.study_iuid }}</span>
      </div>
    </div> <!-- end fxLayout wrapper -->

    <div class="input-wrapper"> <!-- start fxLayout wrapper -->
      <h3 class="details-title">Study details:</h3>
      <div class="current-wrap">
        <!-- procedure -->
        <div class="current-info text-center divider-alt">
          <small>Performed procedure:</small><br/>
          <span class="badge-alt">
            <span *ngIf="performingData.procedure">{{ performingData.procedure.name }}</span>
          </span>
        </div>

        <!-- equipment -->
        <div class="current-info text-center divider-alt">
          <small>Equipment:</small><br/>
          <span *ngIf="performingData.equipment" class="badge-accent" matTooltip="{{ 'AET: ' + performingData.equipment.AET }}">
            <span>{{ performingData.equipment.name }}</span>
          </span>
        </div>

        <!-- modality -->
        <div class="current-info text-center">
          <small>Modality:</small><br/>
          <span *ngIf="performingData.modality" class="badge" matTooltip="{{ performingData.modality.code_meaning }}">
            <span>{{ performingData.modality.code_value }}</span>
          </span>
        </div>

        <div class="clear"></div>
      </div>

      <div class="clear"></div>

      <div class="current-wrap">
          <!-- urgency -->
          <div class="current-info text-center divider-alt">
            <small>Urgency:</small><br/>
            <div *ngIf="performingData.urgency; then thenBlockUrgency else elseBlockUrgency"></div>
            <ng-template #thenBlockUrgency><mat-icon class="color-fail" matTooltip="Urgent">directions_run</mat-icon></ng-template>
            <ng-template #elseBlockUrgency><mat-icon color="accent" matTooltip="Normal">man</mat-icon></ng-template>
          </div>

          <span *ngIf="performingData.appointment">
            <!-- outpatient -->
            <div class="current-info text-center divider-alt">
              <small>Hospitalization:</small><br/>
              <div *ngIf="performingData.appointment.outpatient; then thenBlockOutpatient else elseBlockOutpatient"></div>
              <ng-template #thenBlockOutpatient><mat-icon color="accent" matTooltip="Outpatient">house</mat-icon></ng-template>
              <ng-template #elseBlockOutpatient><mat-icon class="color-fail" matTooltip="Inpatient">hotel</mat-icon></ng-template>
            </div>

            <!--appointment_pdf-->
            <div class="current-info text-center">
              <small>Appointment receipt:</small><br/>
              <mat-icon color="accent" matTooltip="Appointment PDF" (click)="pdfService.createPDF('appointment', performingData.appointment._id)">picture_as_pdf</mat-icon>
            </div>
          </span>
          
          <div class="clear"></div>
      </div>

      <!--medical_signatures-->
      <span *ngIf="reportData && reportData.medical_signatures !== undefined">
        <br/><hr class="dashed"/>
        <h3>Signatures:</h3>
        <span *ngIf="reportData.medical_signatures[0].user !== undefined && reportData.medical_signatures[0].user.person !== undefined; then thenBlockSignatures else elseBlockSignatures"></span>
        <ng-template #thenBlockSignatures>
          <span *ngFor="let current_signature of reportData.medical_signatures">
            <span class="label-info" matTooltip="Signed: {{ current_signature.createdAt | date:'dd/MM/yyyy HH:mm':sharedProp.mainSettings.appSettings.default_utc }}">
              {{ current_signature.user.person.name_01 }}
              <span *ngIf="current_signature.user.person.name_02">{{ ' ' + current_signature.user.person.name_02 }}</span>

              {{ ' ' + current_signature.user.person.surname_01 }}
              <span *ngIf="current_signature.user.person.surname_02">{{ ' ' + current_signature.user.person.surname_02 }}</span>
            </span>
          </span>
        </ng-template>
        <ng-template #elseBlockSignatures>
          <span class="label-fail">UNSIGNED</span>
        </ng-template>
      </span>

    </div> <!-- end fxLayout wrapper -->
  </div>

  <hr class="dashed"/>

  <mat-tab-group [selectedIndex]="tabIndex" (selectedTabChange)="onTabChange($event)">

    <!-- INFO TAB: ------------------------------------------------------------------------------------------------------------------ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">feed</mat-icon> Overview
      </ng-template>

      <div fxLayout="row" fxLayoutAlign="start start">
        <div *ngIf="performingData.appointment && performingData.appointment.private_health && performingData.patient" class="input-wrapper divider"> <!-- start fxLayout wrapper -->
          <h3 class="form-title text-center underline-fail-alt">Patient data <span class="label-alt">Sensitive information</span>:</h3>

          <div fxLayout="row" fxLayoutAlign="start start">
            <div class="input-wrapper divider-alt"> <!-- start fxLayout wrapper -->
              <ul>
                <li *ngIf="performingData.patient.person"><strong>Age: </strong><span matTooltip="Age at the time of the study">{{ sharedFunctions.calculateAge(performingData.patient.person.birth_date, performingData.date) }}</span></li>
                <li><strong>Height:</strong> {{ performingData.appointment.private_health.height }} centimeters</li>
                <li><strong>Weight:</strong> {{ performingData.appointment.private_health.weight }} kilograms</li>
              </ul>
            </div> <!-- end fxLayout wrapper -->

            <div class="input-wrapper"> <!-- start fxLayout wrapper -->
              <ul>
                <li><strong>Medication:</strong>
                  <span innerHTML="{{ performingData.appointment.private_health.medication }}"></span>
                </li>
                <li><strong>Allergies:</strong> {{ performingData.appointment.private_health.allergies }}</li>
              </ul>
            </div> <!-- end fxLayout wrapper -->
          </div>

          <hr class="dashed" />

          <ul>
            <!-- Private health -->
            <span *ngIf="privatehealthAllAreFalse; then thenBlockPrivateHealth else elseBlockPrivateHealth"></span>
            
            <ng-template #thenBlockPrivateHealth>
              <li>No medical history</li>
            </ng-template>
      
            <ng-template #elseBlockPrivateHealth>
              <li>Medical history:<br/>
                <div class="extra-spacing">
                  <span *ngFor="let currentHealth of performingData.appointment.private_health | keyvalue" >
                    <span *ngIf="currentHealth.value == true" class="label-info">{{ privateHealthLang.ES['' + currentHealth.key] }}</span>
                  </span>
                  <div class="clear"></div>
                </div>
              </li>
              <hr class="soft-alt" />
            </ng-template>
            
            <!--Implants-->
            <span *ngIf="implantsAllAreFalse; then thenBlockImplants else elseBlockImplants"></span>
      
            <ng-template #thenBlockImplants>
              <li>No implants</li>
            </ng-template>
      
            <ng-template #elseBlockImplants>
              <li>Implants:<br/>
                <div class="extra-spacing">
                  <span *ngFor="let currentImplant of performingData.appointment.private_health.implants | keyvalue" >
                    <span *ngIf="currentImplant.value == true" class="label-info">{{ privateHealthLang.ES.implants['' + currentImplant.key] }}</span>
                  </span>
                  <div class="clear"></div>
                </div>
              </li>
            </ng-template>
          </ul>

          <!-- COVID-19-->
          <span *ngIf="performingData.appointment.private_health.covid19">
            <h3 class="form-title text-center underline-fail">COVID-19:</h3>
            <br/>
            <ul>
              <span *ngIf="performingData.appointment.private_health.covid19.had_covid; then thenBlockHadCovid19 else elseBlockHadCovid19"></span>
              <ng-template #thenBlockHadCovid19>
                <li>Had COVID-19.</li>
              </ng-template>
              <ng-template #elseBlockHadCovid19>
                <li>Did <strong>NOT</strong> have COVID-19.</li>
              </ng-template>

              <span *ngIf="performingData.appointment.private_health.covid19.vaccinated; then thenBlockVaccinated else elseBlockVaccinated"></span>
              <ng-template #thenBlockVaccinated>
                <li>Has been vaccinated against COVID-19.</li>
              </ng-template>
              <ng-template #elseBlockVaccinated>
                <li>Has <strong>NOT</strong> been vaccinated against COVID-19.</li>
              </ng-template>

              <li *ngIf="performingData.appointment.private_health.covid19.details !== '' && performingData.appointment.private_health.covid19.details !== undefined && performingData.appointment.private_health.covid19.details !== null">
                {{ performingData.appointment.private_health.covid19.details }}
              </li>
            </ul>
          </span>

          <!-- PET-CT -->
          <span *ngIf="performingData && performingData.modality && performingData.modality.code_value == 'PT' && performingData.injection && performingData.injection.pet_ct" >
            <h3 class="form-title text-center underline-fail-alt">PET-CT:</h3>
            <br/>

            <div class="dose">
              <h4>ACTIVIDAD ADMINISTRADA:</h4>
              <span class="badge-warn badge-dose MBq">{{ performingData.injection.pet_ct.administred_activity }} MBq</span>
              <span class="badge-warn badge-dose mCi">{{ sharedFunctions.MBqTomCi(performingData.injection.pet_ct.administred_activity) }} mCi</span>
              <div class="clear"></div><br/>
            </div>
          </span>
          
          <br/>

          <h3 *ngIf="performingData.appointment" class="form-title text-center underline-fail-alt">Report required before <span class="label-info">{{ performingData.appointment.report_before | date:"dd/MM/yyyy":"UTC" }}</span></h3>
          <br/>

          <h4>Anamnesis:</h4>
          <div class="current-wrap details-wrap">
            <!-- anamnesis -->
            <div class="current-info">
              <div *ngIf="performingData.appointment && performingData.appointment.anamnesis !== undefined && performingData.appointment.anamnesis.length > 0; then thenBlockAnamnesis else elseBlockAnamnesis"></div>
          
              <ng-template #thenBlockAnamnesis>
                <span innerHTML="{{ performingData.appointment.anamnesis }}"></span>
              </ng-template>
          
              <ng-template #elseBlockAnamnesis>
                <span>The study does NOT include anamnesis.</span>
              </ng-template>
            </div>
          
            <div class="clear"></div>
          </div>

          <br/><hr class="dashed"/><br/>

          <h4>Indications:</h4>
          <div class="current-wrap details-wrap">
            <!-- indications -->
            <div class="current-info">
              <div *ngIf="performingData.appointment && performingData.appointment.indications !== undefined && performingData.appointment.indications.length > 0; then thenBlockIndications else elseBlockIndications"></div>
          
              <ng-template #thenBlockIndications>
                <span innerHTML="{{ performingData.appointment.indications }}"></span>
              </ng-template>
          
              <ng-template #elseBlockIndications>
                <span>The study does NOT include indications.</span>
              </ng-template>
            </div>
          
            <div class="clear"></div>
            <br/><br/>
          </div>
        </div> <!-- end fxLayout wrapper -->

        <div class="input-wrapper"> <!-- start fxLayout wrapper -->
          
          <h3 class="form-title text-center underline-fail-alt">Preparation and injection:</h3>
          <br/>
          <h4>Observations:</h4>
          <div class="current-wrap details-wrap">
            <!-- observations -->
            <div class="current-info">
              <div *ngIf="performingData.observations !== undefined && performingData.observations.length > 0; then thenBlockObservations else elseBlockObservations"></div>
          
              <ng-template #thenBlockObservations>
                <span innerHTML="{{ performingData.observations }}"></span>
              </ng-template>
          
              <ng-template #elseBlockObservations>
                <span>No observations were recorded during the patient's preparation and injection.</span>
              </ng-template>
            </div>

            <div class="clear"></div>
          </div>


          <h3 class="form-title text-center underline-fail-alt">Acquisition:</h3>
          <br/>
          <!-- contrast -->
          <span *ngIf="performingData.appointment && performingData.appointment.contrast">
            <ul>
              <span *ngIf="performingData.appointment.contrast.use_contrast == true; then thenBlockContrast else elseBlockContrast"></span>
              <ng-template #thenBlockContrast>
                <li><strong>Study performed:</strong> <span class="label-info">With contrast</span></li>
                <li *ngIf="performingData.modality.code_value != 'PT'" ><strong>Contrast type:</strong> {{ performingData.appointment.contrast.description }}</li>
              </ng-template>
              <ng-template #elseBlockContrast>
                <li><strong>Study performed:</strong> Without contrast</li>
              </ng-template>
            </ul>
          </span>
          
          <br/><hr class="dashed"/><br/>

          <h4>Observations:</h4>
          <div class="current-wrap details-wrap">
            <!-- acquisition -> observations -->
            <div class="current-info">
              <div *ngIf="performingData.acquisition && performingData.acquisition.observations !== undefined && performingData.acquisition.observations.length > 0; then thenBlockAcquisitionObservations else elseBlockAcquisitionObservations"></div>
          
              <ng-template #thenBlockAcquisitionObservations>
                <span innerHTML="{{ performingData.acquisition.observations }}"></span>
              </ng-template>
          
              <ng-template #elseBlockAcquisitionObservations>
                <span>No observations were recorded during image acquisition.</span>
              </ng-template>
            </div>
          
            <div class="clear"></div>
          </div>
          

          <br/>

        </div> <!-- end fxLayout wrapper -->

        <div class="clear"></div>
      </div>
    </mat-tab>
    <!-- INFO TAB: ------------------------------------------------------------------------------------------------------------------ -->


    <!-- REPORT TAB: ------------------------------------------------------------------------------------------------------------------ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">edit</mat-icon> Report
        <mat-icon *ngIf="reportTabErrors" class="validate-error-tab" matTooltip="There are validation errors under this tab">priority_high</mat-icon>
      </ng-template>

      <div class="action-wrapper" fxLayout="row" fxLayoutAlign="start start">
        <div class="input-wrapper"> <!-- start fxLayout wrapper -->
          <span><small><mat-icon>coronavirus</mat-icon></small><span class="pathologies-title"> Pathologies:</span></span>
          <br/>
          <mat-form-field class="full" appearance="fill">
            <mat-label>Pathologies</mat-label>
            <input type="text" matInput formControlName="pathologies_input" (keyup)="filterPathologies($event)" [matAutocomplete]="autoPathologies">
            <mat-autocomplete #autoPathologies="matAutocomplete">
              <mat-option (click)="addPathology(currentPathology)" *ngFor="let currentPathology of filteredPathologies" [value]="currentPathology.name">
                {{ currentPathology.name }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div> <!-- end fxLayout wrapper -->

        <div class="input-wrapper"> <!-- start fxLayout wrapper -->
          <span *ngIf="selectedPathologies.length > 0; then thenBlockPathologies else elseBlockPathologies"></span>
          <ng-template #thenBlockPathologies>
            <small>
              <mat-chip-list>
                <mat-chip class="mat-pathology" *ngFor="let currentPathology of selectedPathologies; let i = index">
                  <small>{{ currentPathology.name }}</small>
                  <mat-icon matTooltip="Remove pathology" (click)="removePathology(currentPathology)">close</mat-icon>
                </mat-chip>
              </mat-chip-list>
            </small>
          </ng-template>
          <ng-template #elseBlockPathologies>
            <div class="text-center"><span class="label-info">The report has no pathologies assigned</span></div>
          </ng-template>
        </div> <!-- end fxLayout wrapper -->

        <div class="input-wrapper text-right" [class.signatures-warn]="reportData && reportData.medical_signatures !== undefined && reportData.medical_signatures[0].user !== undefined && reportData.medical_signatures[0].user.person !== undefined"> <!-- start fxLayout wrapper -->
          <!--Report Draft PDF Preview-->
          <button *ngIf="reportData.performing && (reportData.performing.flow_state === 'P07' || reportData.performing.flow_state === 'P08')" mat-mini-fab class="small_button pdf_preview" type="button" (click)="pdfService.createPDF('report_draft', fk_performing)" matTooltip="Report PDF preview"><mat-icon>plagiarism</mat-icon></button>

          <!--Save button-->
          <button mat-mini-fab class="small_button" type="button" (click)="onSubmit('save')" matTooltip="Save" color="primary"><mat-icon>save</mat-icon></button>

          <!-- Superuser, Supervisor, Concessions: [7: Sign reports] -->
          <span *ngIf="sharedProp.userLogged.permissions[0].role == 1 || sharedProp.userLogged.permissions[0].role == 3 || (sharedProp.userLogged.permissions[0].concession && sharedFunctions.checkConcessions(sharedProp, [7]))">
            <button mat-mini-fab class="small_button sign-button"   (click)="passwordRequest('save-sign')" type="button" matTooltip="Save and sign"><mat-icon>draw</mat-icon></button>
          </span>

          <!-- Superuser, Supervisor, (Concessions: [7: Sign reports] AND [8: Authenticate reports]) -->
          <span *ngIf="sharedProp.userLogged.permissions[0].role == 1 || sharedProp.userLogged.permissions[0].role == 3 || ((sharedProp.userLogged.permissions[0].concession && sharedFunctions.checkConcessions(sharedProp, [7])) && (sharedProp.userLogged.permissions[0].concession && sharedFunctions.checkConcessions(sharedProp, [8])))">
            <button mat-mini-fab class="small_button" type="button" (click)="passwordRequest('save-sign-authenticate')" matTooltip="Save, sign, and authenticate" color="accent"><mat-icon>workspace_premium</mat-icon></button>
          </span>
          
          <button mat-mini-fab class="small_button" type="button" matTooltip="Close" routerLink="/performing/list" color="basic"><mat-icon>close</mat-icon></button>

          <!--signatures_warn-->
          <div class="text-left" *ngIf="reportData && reportData.medical_signatures !== undefined && reportData.medical_signatures[0].user !== undefined && reportData.medical_signatures[0].user.person !== undefined">
            <small><hr class="dashed" /><strong>WARNING:</strong> This report <strong>is currently signed</strong>; saving it will be treated as an edit action and <strong>will remove all existing signatures</strong>.</small>
          </div>
        </div> <!-- end fxLayout wrapper -->
      </div>

      <div fxLayout="row" fxLayoutAlign="start start">
        <div class="input-wrapper"> <!-- start fxLayout wrapper -->
          <h3 class="underline-ok">Clinical data: <span class="label-template" matTooltip="Load clinical data" (click)="insertClinicalInfo()"><mat-icon>auto_fix_high</mat-icon></span></h3>
          <div [class.unselected]="clinicalInfoValidator == false">
            <span class="label-editor">min: 10, max: 10000</span>
            <ckeditor formControlName="clinical_info" #clinicalInfo [editor]="clinicalInfoEditor" [config]="sharedProp.mainSettings.CKEditorConfig" data=""></ckeditor>
          </div>

          <br/><hr class="soft-alt" /><br/>

          <h3 class="underline-ok">Procedure: <span class="label-template" matTooltip="Load procedure template" (click)="insertProcedureTemplate()"><mat-icon>auto_fix_high</mat-icon></span></h3>
          <div [class.unselected]="procedureDescriptionValidator == false">
            <span class="label-editor">min: 10, max: 10000</span>
            <ckeditor formControlName="procedure_description" #procedureDescription [editor]="procedureDescriptionEditor" [config]="sharedProp.mainSettings.CKEditorConfig" data=""></ckeditor>
          </div>

          <br/><hr class="soft-alt" /><br/>
        
          <mat-form-field appearance="outline" class="full">
            <mat-label>Findings title</mat-label>
            <input matInput type="text" formControlName="findings_title" placeholder="Enter the findings title">
            <mat-icon matPrefix matTooltip="Load report template" (click)="insertReportTemplate()">auto_fix_high</mat-icon>
          </mat-form-field>

          <span class="label-editor">min: 10, max: 10000</span>
          <ckeditor formControlName="procedure_findings" #procedure_findings [editor]="procedure_findingsEditor" [config]="sharedProp.mainSettings.CKEditorConfig" data=""></ckeditor>

          <br/><hr class="soft-alt" /><br/>

          <h3 class="underline-ok">Summary:</h3>
          <span class="label-editor">min: 10, max: 10000</span>
          <ckeditor formControlName="summary" #summary [editor]="summaryEditor" [config]="sharedProp.mainSettings.CKEditorConfig" data=""></ckeditor>
          
          <br/>
        </div> <!-- end fxLayout wrapper -->
            
      </div>
    </mat-tab>
    <!-- REPORT TAB: ------------------------------------------------------------------------------------------------------------------ -->


    <!-- DICOM TAB: ------------------------------------------------------------------------------------------------------------------ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">visibility</mat-icon> Images
      </ng-template>
   
      <div *ngIf="requestedDICOMController == false">
        <div fxLayout="row" fxLayoutAlign="start start">
          <div class="input-wrapper text-center"> <!-- start fxLayout wrapper -->
            <br/>
            <mat-icon class="no-dicom">visibility_off</mat-icon>

            <br/><br/><hr class="dashed" /><br/>
            <h3>No images were found for the study</h3>
          </div> <!-- end fxLayout wrapper -->
        </div>
      </div>

      <!-- DICOM Viewer at the end of the document (DOM): -->
      <!-- Keep irfame container out of tabs to prevent it from being destroyed and recreated (Multiple DICOM Retrieve) -->
    </mat-tab>
    <!-- DICOM TAB: ------------------------------------------------------------------------------------------------------------------ -->


    <!-- FILES TAB: ------------------------------------------------------------------------------------------------------------------ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">folder</mat-icon> Files
      </ng-template>
      <div fxLayout="row" fxLayoutAlign="start start">
        <div class="input-wrapper">
          <h3 class="form-title text-center underline-fail-alt">Attached files <span class="label-info">Max. {{ sharedProp.mainSettings.appSettings.file_max_size }} MB</span>:</h3>
          <br/>
              
          <span *ngIf="getKeys(fileManager.controller.attached_files.files).length > 0; then thenBlockAttached else elseBlockAttached"></span>
              
          <ng-template #thenBlockAttached>
            <mat-chip-list>
              <mat-chip *ngFor="let currentAtachedFile of fileManager.controller.attached_files.files | keyvalue">
                <mat-icon (click)="fileManager.download(currentAtachedFile.key)">description</mat-icon><span (click)="fileManager.download(currentAtachedFile.key)"> &nbsp;{{ currentAtachedFile.value }}</span> &nbsp;<mat-icon matTooltip="Delete file" (click)="fileManager.delete(currentAtachedFile.key, 'attached_files', { 'element': 'appointments', '_id': performingData.appointment._id, 'current_files': getKeys(this.fileManager.controller.attached_files.files) })">close</mat-icon>
              </mat-chip>
            </mat-chip-list>
            <br/>
          </ng-template>
              
          <ng-template #elseBlockAttached>
            <div class="text-center">
              <mat-icon>folder_off</mat-icon> <h3>No attached files were found.</h3>
            </div>
          </ng-template>
              
          <hr class="dashed" /><br/>
              
          <div class="text-right">
            <input type="file" (change)="fileManager.upload($event, 'attached_files', { 'element': 'appointments', '_id': performingData.appointment._id, 'current_files': getKeys(this.fileManager.controller.attached_files.files) })" #fileInputAttached style="display: none" />
            <button mat-flat-button type="button" [disabled]="fileManager.controller['attached_files'].disabled" color="accent" (click)="fileInputAttached.click()">
              <span *ngIf="fileManager.controller['attached_files'].disabled; then thenBlockAttachedDisabled else elseBlockAttachedDisabled"></span>
              <ng-template #thenBlockAttachedDisabled><mat-icon>cloud_sync</mat-icon> UPLOADING FILE (<small>{{ fileManager.uploadProgress }}%</small>)</ng-template>
              <ng-template #elseBlockAttachedDisabled><mat-icon>attach_file</mat-icon> ATTACH FILE</ng-template>
            </button>
          </div>

          <br/>
        </div> <!-- end fxLayout wrapper -->
      </div>
    </mat-tab>
    <!-- FILES TAB: ------------------------------------------------------------------------------------------------------------------ -->


    <!-- HISTORY TAB: ---------------------------------------------------------------------------------------------------------------- -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">history</mat-icon> Previous studies
      </ng-template>

      <div *ngIf="previous; then thenBlockTable else elseBlockTable"></div>

      <ng-template #thenBlockTable>
        <div #main_list>
          <table mat-table [dataSource]="previous">
            <!-- current -->
            <ng-container matColumnDef="current">
              <th mat-header-cell *matHeaderCellDef class="text-center column-alt"></th>
              <td mat-cell *matCellDef="let element" class="text-center">
                <span *ngIf="element._id == fk_performing"><mat-icon class="current_item" matTooltip="Current">arrow_forward</mat-icon></span>
              </td>
            </ng-container>

            <!-- flow_state -->
            <ng-container matColumnDef="flow_state">
              <th mat-header-cell *matHeaderCellDef class="text-center column-alt">Study flow</th>
              <td mat-cell *matCellDef="let element" class="text-center">
                <!--See report-->
                <span *ngIf="element.flow_state == 'P09'">
                  <button mat-mini-fab class="history_small_button" type="button" (click)="sharedFunctions.reportReview(element._id)" matTooltip="View report" color="accent">
                    <mat-icon>playlist_add_check</mat-icon>
                  </button>
                  <br/>
                </span>

                <!--flow_state-->
                <span class="badge badge-mini {{ element.flow_state }}" matTooltip="{{ cancellation_reasons[element.cancellation_reasons] }}" *ngIf="element.flow_state">{{ performing_flow_states[element.flow_state] }}</span>
              </td>
            </ng-container>

            <!-- date -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef class="text-center column-alt"> Date </th>
              <td mat-cell *matCellDef="let element" class="text-center">
                <span *ngIf="element.date">{{ element.date | date : "dd/MM/yyyy" : "UTC" }}</span>
              </td>
            </ng-container>

            <!-- checkin_time -->
            <ng-container matColumnDef="checkin_time">
              <th mat-header-cell *matHeaderCellDef class="text-center column-alt"> Check-in<br/>time </th>
              <td mat-cell *matCellDef="let element" class="text-center">
                <span *ngIf="element.date">{{ element.date | date : "HH:mm" : "UTC" }}</span>
              </td>
            </ng-container>

            <!-- patient_age -->
            <ng-container matColumnDef="patient_age">
              <th mat-header-cell *matHeaderCellDef matTooltip="Age at the time of the study" class="text-center column-alt"> Age </th>
              <td mat-cell *matCellDef="let element" class="text-center">
                <span *ngIf="element.patient">
                  <span *ngIf="element.patient.person">
                    <span>{{ sharedFunctions.calculateAge(element.patient.person.birth_date, element.date) }}</span>
                  </span>
                </span>
              </td>
            </ng-container>

            <!-- details -->
            <ng-container matColumnDef="details">
              <th mat-header-cell *matHeaderCellDef class="text-center column-alt"> Detail </th>
              <td mat-cell *matCellDef="let element">
                <!-- procedure -->
                <span *ngIf="element.procedure">
                  <span class="badge-alt" matTooltip="{{ element.procedure.code }}">{{ element.procedure.name }}</span>
                </span>

                <div class="clear"></div><hr class="dashed" />

                <!-- equipment -->        
                <span *ngIf="element.equipment; then thenBlockTableEquipment else elseBlockTableEquipment"></span>
                    <ng-template #thenBlockTableEquipment>
                    <span class="badge-accent" matTooltip="{{ 'AET: ' + element.equipment.AET }}">
                    <span>{{ element.equipment.name }}</span>
                    </span>
                </ng-template>
                <ng-template #elseBlockTableEquipment>(No data)</ng-template>

                <!-- modality -->
                <span *ngIf="element.modality; then thenBlockTableModality else elseBlockTableModality"></span>
                <ng-template #thenBlockTableModality>
                  <span class="badge" matTooltip="{{ element.modality.code_meaning }}">{{ element.modality.code_value }}</span>
                </ng-template>
                <ng-template #elseBlockTableModality>(No data)</ng-template>
              </td>
            </ng-container>

            <!-- domain -->
            <ng-container matColumnDef="domain">
              <th mat-header-cell *matHeaderCellDef class="text-center column-alt">Domain</th>
              <td mat-cell *matCellDef="let element">
                <div *ngIf="element.appointment" class="domain-container">
                  <!--referring-->
                  <small><strong>Requester: </strong></small>
                  <span *ngIf="element.appointment.referring; then thenBlockReferring else elseBlockReferring"></span>
                  <ng-template #thenBlockReferring>
                    <small>
                      <span *ngIf="element.appointment.referring.organization">{{ element.appointment.referring.organization.short_name }}</span>
                      <span *ngIf="element.appointment.referring.branch"> ► {{ element.appointment.referring.branch.short_name }}</span>
                      <span *ngIf="element.appointment.referring.service"> ► {{ element.appointment.referring.service.name }}</span>
                    </small>
                  </ng-template>
                  <ng-template #elseBlockReferring>(No data)</ng-template>

                  <hr class="dashed" />

                  <!--imaging-->
                  <small><strong>Performer: </strong></small>
                  <span *ngIf="element.appointment.imaging; then thenBlockImaging else elseBlockImaging"></span>
                  <ng-template #thenBlockImaging>
                    <small>
                      <span *ngIf="element.appointment.imaging.organization">{{ element.appointment.imaging.organization.short_name }}</span>
                      <span *ngIf="element.appointment.imaging.branch"> ► {{ element.appointment.imaging.branch.short_name }}</span>
                      <span *ngIf="element.appointment.imaging.service"> ► {{ element.appointment.imaging.service.name }}</span>
                    </small>
                  </ng-template>
                  <ng-template #elseBlockImaging>(No data)</ng-template>

                  <hr class="dashed" />

                  <!--reporting-->
                  <small><strong>Reporter: </strong></small>
                  <span *ngIf="element.appointment.reporting; then thenBlockReporting else elseBlockReporting"></span>
                  <ng-template #thenBlockReporting>
                    <small>
                      <span *ngIf="element.appointment.reporting.organization">{{ element.appointment.reporting.organization.short_name }}</span>
                      <span *ngIf="element.appointment.reporting.branch"> ► {{ element.appointment.reporting.branch.short_name }}</span>
                      <span *ngIf="element.appointment.reporting.service"> ► {{ element.appointment.reporting.service.name }}</span>
                    </small>
                  </ng-template>
                  <ng-template #elseBlockReporting>(No data)</ng-template>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </ng-template>
          
      <!-- Await previous or not previous -->
      <ng-template #elseBlockTable>
        <div fxLayout="row" fxLayoutAlign="center center" class="response-info">
          No previous studies were found.
        </div>
      </ng-template>
    </mat-tab>
    <!-- HISTORY TAB: ---------------------------------------------------------------------------------------------------------------- -->


    <!-- AMEND TAB: ------------------------------------------------------------------------------------------------------------------- -->
    <mat-tab *ngIf="amendmentsData !== false">
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">rule</mat-icon> Amendments
      </ng-template>

      <div fxLayout="row" fxLayoutAlign="start start">
        <div class="input-wrapper"> <!-- start fxLayout wrapper -->

          <span *ngFor="let current_report of amendmentsData; let i = index">
            <h3 class="form-title text-center underline-fail-alt">Historical report {{ amendmentsData.length - i  + ' of ' + amendmentsData.length }}</h3>

            <div fxLayout="row" fxLayoutAlign="start start">
              <div class="input-wrapper"> <!-- start fxLayout wrapper -->
                <h3 class="form-title">
                  Creation date:
                  <span class="label-accent">{{ current_report.createdAt | date:'dd/MM/yyyy HH:mm':sharedProp.mainSettings.appSettings.default_utc }}</span><br/>

                  Authenticated by:
                  <span class="label-alt" matTooltip="Authenticated: {{ current_report.authenticated.datetime | date:'dd/MM/yyyy HH:mm':'UTC' }}">
                    {{ current_report.authenticated.user.person.name_01 }}
                    <span *ngIf="current_report.authenticated.user.person.name_02">{{ ' ' + current_report.authenticated.user.person.name_02 }}</span>

                    {{ ' ' + current_report.authenticated.user.person.surname_01 }}
                    <span *ngIf="current_report.authenticated.user.person.surname_02">{{ ' ' + current_report.authenticated.user.person.surname_02 }}</span>
                  </span><br/>

                  Signed by:
                  <span *ngFor="let current_signature of current_report.medical_signatures">
                    <span class="label-info" matTooltip="Signed: {{ current_signature.createdAt | date:'dd/MM/yyyy HH:mm':sharedProp.mainSettings.appSettings.default_utc }}">
                      {{ current_signature.user.person.name_01 }}
                      <span *ngIf="current_signature.user.person.name_02">{{ ' ' + current_signature.user.person.name_02 }}</span>

                      {{ ' ' + current_signature.user.person.surname_01 }}
                      <span *ngIf="current_signature.user.person.surname_02">{{ ' ' + current_signature.user.person.surname_02 }}</span>
                    </span>
                  </span>
                </h3>
              </div> <!-- end fxLayout wrapper -->

              <div class="input-wrapper"> <!-- start fxLayout wrapper -->
                <span *ngIf="current_report.pathologies.length > 0; then thenBlockCurrentPathologies else elseBlockCurrentPathologies"></span>
                <ng-template #thenBlockCurrentPathologies>
                  <small>
                    <br/>
                    <mat-chip-list>
                      <mat-chip class="mat-pathology" *ngFor="let currentPathology of current_report.pathologies; let i = index">
                        <small>{{ currentPathology.name }}</small>
                      </mat-chip>
                    </mat-chip-list>
                  </small>
                </ng-template>
                <ng-template #elseBlockCurrentPathologies>
                  <span class="label-accent">The report has no pathologies assigned</span>
                </ng-template>
              </div> <!-- end fxLayout wrapper -->
            </div>

            <mat-accordion>
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Click here to show or hide the content of report No. {{ amendmentsData.length - i }}
                  </mat-panel-title>
                </mat-expansion-panel-header>
                
                <br/>

                <div class="report-wrap">
                  <span *ngIf="current_report.clinical_info">
                    <h3 class="report-underline"><strong>Clinical data:</strong></h3>
                    <span innerHTML="{{ current_report.clinical_info }}"></span>
                  </span>

                  <span *ngIf="current_report.procedure_description">
                    <br/><hr class="soft-alt" /><br/>
      
                    <h3 class="report-underline"><strong>Procedure:</strong></h3>
                    <span innerHTML="{{ current_report.procedure_description }}"></span>
                  </span>
                  
                  <span *ngIf="current_report.findings[0]">
                    <br/><hr class="soft-alt" /><br/>
      
                    <h3 class="report-underline"><strong>{{ current_report.findings[0].title }}:</strong></h3>
                    <span innerHTML="{{ current_report.findings[0].procedure_findings }}"></span>
                  </span>
                  
                  <span *ngIf="current_report.summary">
                    <br/><hr class="soft-alt" /><br/>
        
                    <h3 class="report-underline"><strong>Summary:</strong></h3>
                    <span innerHTML="{{ current_report.summary }}"></span>
                  </span>
                  <br/>
                </div>

              </mat-expansion-panel>
            </mat-accordion>

            <br/><br/>
          </span>

        </div> <!-- end fxLayout wrapper -->
      </div>

    </mat-tab>
    <!-- AMEND TAB: ------------------------------------------------------------------------------------------------------------------- -->

  </mat-tab-group>

  <!-- DICOM Viewer -->
  <!-- Keep irfame container out of tabs to prevent it from being destroyed and recreated (Multiple DICOM Retrieve) -->
  <div [class.non-display]="tabIndex !== 2" class="iframe-container">
    <app-dcm-viewer src="{{ ohifPath }}"></app-dcm-viewer>
  </div>
</form>
  