<span *ngIf="this.sharedProp.current_patient && this.sharedProp.current_imaging && this.sharedProp.current_modality && this.sharedProp.current_procedure; then thenBlockCurrentObj else elseBlockCurrentObj"></span>

<ng-template #thenBlockCurrentObj>
  <form class="form-element" [formGroup]="form" (ngSubmit)="onSubmit()">
    <div fxLayout="row" fxLayoutAlign="start start">
      <div class="input-wrapper divider"> <!-- start fxLayout wrapper -->
        <h2 class="form-title text-center underline-fail-alt">Patient details:</h2><br/>

        <span *ngIf="this.sharedProp.current_patient">
          <span *ngIf="this.sharedProp.current_patient.person">

            <div class="current-wrap">
              <!-- documents -->
              <div class="current-info">
                <small>Document(s):</small><br/>
                <span *ngFor="let current of this.sharedProp.current_patient.person.documents" >
                  <span matTooltip="{{ country_codes[current.doc_country_code].name }}" class="flag-icon flag-icon-{{ country_codes[current.doc_country_code].alpha_2 | lowercase }}"></span>&nbsp;
                  <span matTooltip="{{ document_types[current.doc_type] }}">
                    <span innerHTML="{{ current.document | highlighter : sharedProp.filter }}"></span>
                  </span>
                  <br/>
                </span>
              </div>

              <!-- names -->
              <div class="current-info">
                <small>Full name:</small><br/>
                <span class="current-firts">
                  <span>{{ this.sharedProp.current_patient.person.name_01 }}</span>

                  <span *ngIf="this.sharedProp.current_patient.person.name_02">
                    <span> {{ this.sharedProp.current_patient.person.name_02 }}</span>
                  </span>

                  <span> {{ this.sharedProp.current_patient.person.surname_01 }}</span>

                  <span *ngIf="this.sharedProp.current_patient.person.surname_02">
                    <span> {{ this.sharedProp.current_patient.person.surname_02 }}</span>
                  </span>
                </span>
              </div>

              <div class="clear"></div>
            </div>

            <div class="clear"></div>

            <div class="current-wrap">
              <!-- birth_date -->
              <div class="current-info">
                <small>Birth date:</small><br/>
                <span class="current-firts">{{ this.sharedProp.current_patient.person.birth_date | date:"dd/MM/yyyy":"UTC" }}</span>
              </div>

              <!-- genre -->
              <div class="current-info text-center">
                <small>Gender:</small><br/>
                <span [ngSwitch]="this.sharedProp.current_patient.person.gender" matTooltip="{{ gender_types[this.sharedProp.current_patient.person.gender] }}">
                  <span *ngSwitchCase="1"><mat-icon class="male">man</mat-icon></span>
                  <span *ngSwitchCase="2"><mat-icon class="female">woman</mat-icon></span>
                  <span *ngSwitchCase="3"><mat-icon class="other">wc</mat-icon></span>
                </span>
              </div>

              <!-- status -->
              <div class="current-info text-center">
                <small>Status:</small><br/>
                <span *ngIf="this.sharedProp.current_patient.status; then thenBlock else elseBlock"></span>
                <ng-template #thenBlock><mat-icon class="color-ok" matTooltip="Active">done</mat-icon></ng-template>
                <ng-template #elseBlock><mat-icon class="color-fail" matTooltip="Inactive">clear</mat-icon></ng-template>
              </div>

              <div class="clear"></div>
            </div>

            <!-- friendly password -->
            <div class="friendly-pass-wrap" *ngIf="this.sharedProp.current_friendly_pass !== ''">
              <div class="current-info">Assigned random password: </div>
              <div class="current-info">
                <span class="friendly-pass">{{ this.sharedProp.current_friendly_pass }}</span>
              </div>
              <div class="clear"></div><hr class="dashed" />
              <small><strong>Note: </strong>Once the appointment entry is completed the assigned password will no longer be accessible.</small>
            </div>

          </span>
        </span>
      </div> <!-- end fxLayout wrapper -->

      <div class="input-wrapper"> <!-- start fxLayout wrapper -->
        <h2 class="form-title text-center underline-fail-alt">Exam execution:</h2><br/>

        <span *ngIf="this.sharedProp.current_imaging">
          <span *ngIf="this.sharedProp.current_imaging.organization && this.sharedProp.current_imaging.branch && this.sharedProp.current_imaging.service && currentModality">

            <div class="current-wrap">
              <!-- imaging and modality -->
              <div class="current-info">
                <small>Organization ► Branch ► Service:</small><br/>
                <span class="current-firts">{{ this.sharedProp.current_imaging.organization.short_name + ' ► ' + this.sharedProp.current_imaging.branch.short_name + ' ► ' + this.sharedProp.current_imaging.service.name }}</span>
              </div>

              <div class="clear"></div>
            </div>

            <div class="clear"></div>

            <div class="current-wrap">
              <!-- procedure -->
              <div class="current-info text-center">
                <small>Procedure to perform:</small><br/>
                <span class="badge-alt">
                  <span>{{ this.sharedProp.current_procedure.name }}</span>
                </span>
              </div>

              <!-- modality -->
              <div class="current-info text-center">
                <small>Modality:</small><br/>
                <span class="badge" matTooltip="{{ currentModality.code_meaning }}">
                  <span>{{ currentModality.code_value }}</span>
                </span>
              </div>

              <!-- informed_consent -->
              <div class="current-info text-center">
                <small>Requires informed consent:</small><br/>
                <span *ngIf="this.sharedProp.current_procedure.informed_consent; then thenBlock else elseBlock"></span>
                <ng-template #thenBlock><mat-icon class="color-ok" matTooltip="YES">done</mat-icon></ng-template>
                <ng-template #elseBlock><mat-icon class="color-fail" matTooltip="NO">clear</mat-icon></ng-template>
              </div>

              <div class="clear"></div>
            </div>

          </span>
        </span>
      </div> <!-- end fxLayout wrapper -->

    </div>

    <hr class="dashed"/>

    <div class="calendar-container divider-alt">
      <!-- FullCalendar Datepicker -->
      <mat-form-field appearance="fill" id="invisible-datepicker" class="invisible-datepicker large" (click)="picker.open()">
        <mat-label>Select date</mat-label>
        <input matInput [matDatepicker]="picker" [min]="minDate" [max]="maxDate" (keydown)="false" (dateChange)="onChangeDate($event)">
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <!-- FullCalendar -->
      <full-calendar #calendar [options]="calendarOptions"></full-calendar>

      <br/>

      <button mat-flat-button type="button" appearance="fill" (click)="setResources('ALL')">All equipment</button>
      <span *ngFor="let currentResource of calendarResources">
        <button mat-flat-button type="button" appearance="fill" color="accent" (click)="setResources(currentResource.id)">{{ currentResource.title.split('|')[0] }}</button>
      </span>
      <br/>
    </div>

    <!-- Slot info container -->
    <div class="slot-container">
      <h4 class="underline-ok-alt">Equipment details:</h4>

      <div class="current-wrap" [class.unselected]="selectedEquipment == undefined">
        <!-- selected equipment -->
        <div class="current-info">
          <small>Selected equipment:</small><br/>
          <span *ngIf="selectedEquipment == undefined; then thenBlockEquipment else elseBlockEquipment"></span>
          <ng-template #thenBlockEquipment><span class="current-firts">No data</span></ng-template>
          <ng-template #elseBlockEquipment><span class="current-firts">{{ selectedEquipment.details.name }}</span></ng-template>
        </div>
        <div class="clear"></div>
      </div>

      <div class="current-wrap" [class.unselected]="selectedEquipment == undefined">
        <!-- selected equipment duration -->
        <div class="current-info">
          <small>Procedure duration:</small><br/>
          <span *ngIf="selectedEquipment == undefined; then thenBlockEquipmentDuration else elseBlockEquipmentDuration"></span>
          <ng-template #thenBlockEquipmentDuration><span class="current-firts">No data</span></ng-template>
          <ng-template #elseBlockEquipmentDuration><span class="current-firts">{{ selectedEquipment.duration }} <small>min.</small></span></ng-template>
        </div>
        <div class="clear"></div>
      </div>

      <br/><hr class="dashed" /><br/>

      <h4 class="underline-ok-alt">Appointment details:</h4>

      <div class="current-wrap" [class.unselected]="selectedStart == undefined">
        <!-- selected date -->
        <div class="current-info">
          <small>Appointment date:</small><br/>
          <span *ngIf="selectedStart == undefined; then thenBlockDate else elseBlockDate"></span>
          <ng-template #thenBlockDate><span class="current-firts">No data</span></ng-template>
          <ng-template #elseBlockDate><span class="current-firts">{{ selectedStart | date:"dd/MM/yyyy":"UTC" }}</span></ng-template>
        </div>
        <div class="clear"></div>
      </div>

      <!-- selected start -->
      <div class="current-wrap" [class.unselected]="selectedStart == undefined">
        <div class="current-info">
          <small>Start time:</small><br/>
          <span *ngIf="selectedStart == undefined; then thenBlockStart else elseBlockStart"></span>
          <ng-template #thenBlockStart><span class="current-firts">No data</span></ng-template>
          <ng-template #elseBlockStart><span class="current-firts">{{ selectedStart | date:"HH:mm":"UTC" }}</span></ng-template>
        </div>
        <div class="clear"></div>
      </div>

      <!-- selected end -->
      <div class="current-wrap" [class.unselected]="selectedEnd == undefined">
        <div class="current-info">
          <small>End time:</small><br/>
          <span *ngIf="selectedEnd == undefined; then thenBlockEnd else elseBlockEnd"></span>
          <ng-template #thenBlockEnd><span class="current-firts">No data</span></ng-template>
          <ng-template #elseBlockEnd><span class="current-firts">{{ selectedEnd | date:"HH:mm":"UTC" }}</span></ng-template>
        </div>

        <div class="clear"></div>
      </div>

      <br/><hr class="dashed" /><br/>

      <div class="text-center">
        <h4>Urgency</h4>
        <mat-radio-group aria-label="Urgency" color="primary" formControlName="urgency" (change)="onCheckUrgency($event)">
          <mat-radio-button value="true">Yes</mat-radio-button>
          <mat-radio-button value="false">No</mat-radio-button>
        </mat-radio-group>
      </div>

      <br/><hr class="dashed" /><br/>

      <div *ngIf="selectedEquipment && selectedStart && selectedEnd && selectedSlot" class="text-center">
        <button mat-flat-button type="button" color="accent" (click)="onDelete();"><mat-icon>delete_forever</mat-icon>&nbsp; CLEAR SELECTION</button>
      </div>

      <!-- 1: Superuser, 2: Administrator, Permissions: [23: Overbooking] -->
      <div class="text-center" *ngIf="sharedProp.userLogged.permissions[0].role == 1 || sharedProp.userLogged.permissions[0].role == 2 || (sharedProp.userLogged.permissions[0].concession && sharedFunctions.checkConcessions(sharedProp, [23]))" >
        <br/><hr class="dashed" /><br/>
        <mat-checkbox color="primary" (change)="onCheckOverbooking($event)">Allow overbooking</mat-checkbox>
      </div>
      
      <br/>

    </div>

    <div class="clear"></div>

    <div class="action-wrapper"fxLayout="row" fxLayoutAlign="end center">
      <div> <!-- start fxLayout wrapper -->
        <button mat-flat-button type="button" (click)="onCancel();">CANCEL</button>
        <button mat-flat-button type="button" color="accent" routerLink="/appointments/select_procedure">◄&nbsp; BACK</button>
        <button mat-flat-button type="submit" color="primary" [disabled]="selectedEquipment && selectedStart && selectedEnd && selectedSlot ? undefined : true">NEXT &nbsp;►</button>
      </div> <!-- end fxLayout wrapper -->
    </div>
  </form>
</ng-template>

<ng-template #elseBlockCurrentObj>
  <form class="form-element text-center">
    <br/>
    <mat-icon class="search-off-icon">search_off</mat-icon>

    <br/><br/><hr class="dashed" /><br/>
    <h4>Not enough information was found to continue (patient, service, modality, and/or procedure).</h4>

    <button mat-flat-button type="button" (click)="onCancel();">RETURN TO LIST</button>

    <br/><br/>
  </form>
</ng-template>
